# 读写分离 {#concept_hbh_m45_j2b .concept}

所有POLARDB集群自带读写分离功能。新建POLARDB集群时，系统将自动为集群分配一个VPC网络的读写分离地址。应用程序只需连接一个读写分离地址，写请求会自动发往主实例，读请求会自动根据各实例的负载（当前未完成的请求数）发往主实例或只读实例。

**说明：** 

-   目前仅有VPC网络的读写分离地址，没有公网的读写分离地址。
-   2018年7月6日起，新建POLARDB集群时，系统将自动为集群分配一个VPC网络的读写分离地址，因此不需要申请读写分离地址。对于存量集群（2018年7月6日前购买的集群），则需要在集群信息页面申请。

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/15443/15331038116843_zh-CN.png)


## 功能优势 {#section_rfw_ys5_j2b .section}

-   **维护方便**

    在传统模式下，您需要在应用程序中配置主实例和每个只读实例的连接地址，并且对业务逻辑进行拆分，才能实现将写请求发往主实例而将读请求发往各个实例。

    读写分离功能提供一个读写分离地址，应用程序连接该地址后即可对主实例和只读实例进行读写操作，读写请求会被自动转发，转发逻辑完全对使用者透明，可降低维护成本。

    同时，用户只需添加只读实例的个数，即可不断扩展系统的处理能力，应用程序上无需做任何修改。

-   **原生支持读写分离，提升性能**

    如果您在云上通过自己搭建代理层实现读写分离，在数据到达数据库之前需要经历多个组件的语句解析和转发，对响应延迟有较大的影响。而POLARDB读写分离在已有的高安全链路中直接内置，没有任何额外的组件来消耗时间，能够有效降低延迟，提升处理速度。

-   **实例健康检查，提升数据库系统的可用性**

    读写分离模块自动对集群内的所有实例进行健康检查，当发现某个实例宕机或者延迟超过阈值后，将不再分配读请求给该实例，读写请求在剩余的健康实例间进行分配。以此确保单个只读实例发生故障时，不会影响应用的正常访问。当实例被修复后，POLARDB会自动将该实例纳回请求分配体系内。

-   **免费使用，降低资源及维护成本**

    免费提供读写分离功能，无需支付任何额外费用。


## 转发逻辑 {#section_mvw_kt5_j2b .section}

-   只发往主实例
    -   所有DML操作（INSERT,UPDATE,DELETE\)
    -   所有DDL操作（建表/库，删表/库，变更表结构，权限等）
    -   所有事务中的请求
    -   用户自定义函数
    -   EXECUTE语句
    -   使用到临时表的请求
    -   SELECT last\_insert\_id\(\)
    -   所有对用户变量的查询和更改
    -   SHOW PROCESSLIST
    -   KILL（SQL语句中的KILL，非命令KILL）
-   发往只读实例或主实例
    -   非事务中的读请求
    -   COM\_STMT\_EXECUTE命令
-   总是发往所有实例
    -   所有系统变量的更改
    -   USE命令
    -   COM\_STMT\_PREPARE命令
    -   COM\_CHANGE\_USER/COM\_QUIT/COM\_SET\_OPTION等命令

## 使用限制 {#section_e1j_d55_j2b .section}

-   不支持[COM\_PROCESS\_KILL](https://dev.mysql.com/doc/internals/en/com-process-kill.html)，但是支持在SQL语句中包含KILL语句
-   KILL\[CONNECTION|QUERY\]*processlist\_id*请求中的*processlist\_id*需通过show processlist获得，不能用建立连接时API返回的theadid/*processlist\_id*
-   不支持[Multi Statements](https://dev.mysql.com/doc/internals/en/multi-statement.html)和存储过程。若执行了Multi Statements或存储过程，当前连接的后续请求会全部路由到主库，需断开当前连接并重新连接才能恢复读写分离。

## 查看或修改读写分离地址 {#section_ksd_h55_j2b .section}

1.  进入[POLARDB控制台](https://polardb.console.aliyun.com/)，单击左侧的**集群列表**。
2.  在**集群列表**页面，选择地域，即可显示您账号下在该地域的所有集群。
3.  单击一个集群的ID或**操作**列中的**管理**。

    在访问信息中即可查看或修改集群的读写分离地址。


## FAQs {#section_hrr_m55_j2b .section}

1.  为什么刚插入的语句，立即查的时候查不到？

    答：读写分离的架构下，主从复制会有延迟，所以导致可能会查不到，建议业务逻辑上有依赖的请求封装到同一个事务中。

2.  为什么某个实例的请求数比别的实例多？

    答：当前是根据负载来分发请求的，负载小的实例接收的请求数会更多。

3.  是否支持0毫秒延迟的读取？

    答：POLARDB集群的主实例和只读实例在正常负载情况下，具有毫秒级的延迟，读写分离连接地址暂时不支持在数据写入后0毫秒的读取。如果要求0毫秒延迟的读取，可使用集群连接地址（动态指向POLARDB主实例）将读写请求发给主实例。


